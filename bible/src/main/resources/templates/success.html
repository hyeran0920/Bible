<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="https://static.toss.im/icons/png/4x/icon-toss-logo.png" />
    <link rel="stylesheet" type="text/css" href="style.css" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í† ìŠ¤í˜ì´ë¨¼ì¸  ìƒ˜í”Œ í”„ë¡œì íŠ¸</title>
    
    <!-- Axios ì¶”ê°€ -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  </head>

  <body>
    <div class="box_section" style="width: 600px">
      <img width="100px" src="https://static.toss.im/illusts/check-blue-spot-ending-frame.png" />
      <h2>ê²°ì œë¥¼ ì™„ë£Œí–ˆì–´ìš”</h2>

      <div class="p-grid typography--p" style="margin-top: 50px">
        <div class="p-grid-col text--left"><b>ê²°ì œê¸ˆì•¡</b></div>
        <div class="p-grid-col text--right" id="amount"></div>
      </div>
      <div class="p-grid typography--p" style="margin-top: 10px">
        <div class="p-grid-col text--left"><b>ì£¼ë¬¸ë²ˆí˜¸</b></div>
        <div class="p-grid-col text--right" id="orderId"></div>
      </div>
      <div class="p-grid typography--p" style="margin-top: 10px">
        <div class="p-grid-col text--left"><b>paymentKey</b></div>
        <div class="p-grid-col text--right" id="paymentKey" style="white-space: initial; width: 250px"></div>
      </div>
      <div class="p-grid" style="margin-top: 30px">
        <button class="button p-grid-col5" onclick="location.href='http://localhost:3000';">í™ˆìœ¼ë¡œ</button>
		<button class="button p-grid-col5" onclick="location.href='http://localhost:3000/cart';" style="background-color: #e8f3ff; color: #1b64da">
			êµ¬ë§¤ ë‚´ì—­ í™•ì¸
		</button>
      </div>
    </div>

	<!-- 
    <div class="box_section" style="width: 600px; text-align: left">
      <b>Response Data :</b>
      <div id="response" style="white-space: initial"></div>
    </div>
	 -->
	 
    <script type="module">
      import { fetchOrders, fetchOrderHistory, fetchBookPrice, fetchMemInfo, validateTotalPrice, generateRandomString } from "./paymentUtils.js";
      const BASE_URL=`http://localhost:8080/api/`;
      
    
	  //get order history id
      const urlParams = new URLSearchParams(window.location.search);
      const orderHistoryId = urlParams.get("orderHistoryId");
      console.log("ì£¼ë¬¸ ë‚´ì—­ ID:", orderHistoryId);
      
      
      //Get Orders, Order History Data
      let orderHistory=null;
      let orders=null;

      try {
	        orderHistory = await fetchOrderHistory(orderHistoryId); //orderHistory ê°€ì ¸ì˜¤ê¸°
	        console.log("ì£¼ë¬¸ ë‚´ì—­:", orderHistory);
	
	        orders = await fetchOrders(orderHistoryId); // í•´ë‹¹ orderHistoryì˜ orders ê°€ì ¸ì˜¤ê¸°
	        console.log("ì£¼ë¬¸ ëª©ë¡:", orders);
	        
	        if(!orders || !orderHistory){throw new Error("empty orders");}
	        
	        
	    } catch (error) {
	    	throw new Error("`main()` ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
	    }
      
  	
      
	    
	    
      
      
      
      // ì„œë²„ë¡œ ê²°ì œ ìŠ¹ì¸ì— í•„ìš”í•œ ê²°ì œ ì •ë³´ë¥¼ ë³´ë‚´ê¸°
      async function confirm() {
        var requestData = {
          paymentKey: urlParams.get("paymentKey"),
          orderId: urlParams.get("orderId"),
          amount: urlParams.get("amount"),
        };

        
        const response = await fetch("/confirm", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(requestData),
        });
		
        
      	//ê²°ê³¼ ë°ì´í„°
        const json = await response.json();


		//Check total Price
      	const targetAmount=await validateTotalPrice(orders, orderHistory);
	  	console.log("ê²°ì œë˜ì–´ì•¼ í•˜ëŠ” ê¸ˆì•¡=",targetAmount);
      	
      	// ê²°ì œ ì‹¤íŒ¨
        if (!response.ok || targetAmount!=json.totalAmount) {
          // TODO: ê²°ì œ ì‹¤íŒ¨ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ êµ¬í˜„í•˜ì„¸ìš”.
          console.log("ì‹¤ì œ ê²°ì œ ê¸ˆì•¡=",json.totalAmount);
          console.log(json);
          updateOrderHistory(json,true);
          window.location.href = `/fail?message=${json.message}&code=${json.code}`;
        }
        else{
        	// ê²°ì œ ì„±ê³µ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
            updateOrderHistory(json,false);
        }
        
      	
        return json;
      }
      
      
      
      
      
      async function updateOrderHistory(resultData, isFail) {
    	try {
       		const updateData = {
            	orderHistoryId: orderHistory.orderHistoryId,  // í•„ë“œëª… ì¶”ê°€
            	memId: orderHistory.memId,
            	addressId: orderHistory.addressId,
            	orderHistoryDate: null,
            	orderHistoryTotalPrice: orderHistory.orderHistoryTotalPrice,
            	orderHistoryReceivedName: orderHistory.orderHistoryReceivedName,
            	orderPaymentMethod: isFail ? "fail" : (resultData.method || "unknown"),
            	orderPaymentStatus: isFail ? "0" : "1",
            	orderTossPaymentKey: isFail ? "fail" : resultData.paymentKey
        	};

        console.log("ğŸ“ Updating Order History:", updateData);

        await axios.put(BASE_URL + `orderhistory`, updateData);  // `await` ì¶”ê°€

        console.log("Order History Updated Successfully!");
    	} catch (error) {
        	console.error("Error - updating order history:", error.message);
    	}
	}

      
      
      
      
      //confirm functino ì‹¤í–‰
      confirm().then(function (data) {
        document.getElementById("response").innerHTML = `<pre>${JSON.stringify(data, null, 4)}</pre>`;
      });

      
      
      
      
      
      //parameter
      const paymentKeyElement = document.getElementById("paymentKey");
      const orderIdElement = document.getElementById("orderId");
      const amountElement = document.getElementById("amount");

      orderIdElement.textContent = urlParams.get("orderId");
      amountElement.textContent = urlParams.get("amount") + "ì›";
      paymentKeyElement.textContent = urlParams.get("paymentKey");
      
      
      
      
    </script>
  </body>
</html>
